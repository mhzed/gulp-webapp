// Generated by CoffeeScript 1.8.0
(function() {
  var fs, gulp, gulpFileDst, less, minFile, minifyCSS, minifyJs, path, through;

  fs = require("fs");

  path = require("path");

  through = require("through2");

  gulp = require("gulp");

  gulpFileDst = require("gulp-filedst");

  minifyCSS = require('gulp-minify-css');

  minifyJs = require('gulp-uglify');

  less = require('gulp-less');

  minFile = function(fp) {
    var ext;
    ext = path.extname(fp);
    return path.dirname(fp) + "/" + path.basename(fp, ext) + ".min" + ext;
  };

  module.exports = function(dstBaseDir) {
    var _memory;
    _memory = {};
    return through.obj(function(attr, unused, cb) {
      var dst, mfile, minifier, param, pipe, srcfile, task, _ref;
      if (!attr.gulp) {
        return cb(null, attr);
      }
      srcfile = path.join(attr.basedir, attr.relative);
      if (srcfile in _memory) {
        return cb();
      }
      _memory[srcfile] = 1;
      pipe = gulp.src(srcfile);
      dst = gulp.dest(path.dirname(path.join(dstBaseDir, attr.relative)));
      _ref = attr.gulp;
      for (task in _ref) {
        param = _ref[task];
        switch (task) {
          case 'min':
            mfile = minFile(srcfile);
            if (fs.existsSync(mfile)) {
              pipe = gulp.src(mfile);
            } else {
              if (attr.href) {
                minifier = minifyCSS();
              } else {
                minifier = minifyJs();
              }
              pipe = pipe.pipe(minifier);
            }
            break;
          case 'less':
            pipe = pipe.pipe(less());
            break;
          case 'cp':
            pipe = pipe;
            break;
          case 'cat':
            dst = gulpFileDst(path.join(dstBaseDir, param));
            break;
          case 'skip':
            dst = through.obj();
            break;
          default:
            console.log("Ignore unknow task " + task);
        }
      }
      return pipe.pipe(dst).on('finish', function() {
        return cb(null, attr);
      });
    });
  };

}).call(this);

//# sourceMappingURL=gulp-buildapp.js.map
